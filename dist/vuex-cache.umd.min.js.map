{"version":3,"file":"vuex-cache.umd.min.js","sources":["../src/vuex-cache.js"],"sourcesContent":["/**\n * Check if value is an object.\n * @param {any} value\n * @returns {value is Object}\n */\nconst isObject = value => !!value && typeof value === 'object'\n\n/**\n * Type alias for Store or ActionContext instances.\n * @typedef {import('vuex').Store<any> | import('vuex').ActionContext<any, any>} Store\n */\n\n/**\n * Convert value to `string`.\n * @param {any} value\n * @returns {string}\n */\nconst toString = value =>\n  isObject(value) ? JSON.stringify(value) : String(value)\n\n/**\n * Dispatch's options object.\n * @typedef {import('vuex').DispatchOptions & { timeout: number }} DispatchOptions\n */\n\n/**\n * Dispatch's payload object.\n * @typedef {import('vuex').Payload & { timeout: number }} Payload\n */\n\n/**\n * Type alias for Dispatch parameters.\n * @typedef {[string, any?, DispatchOptions?]|[Payload, DispatchOptions?]} DispatchParams\n */\n\n/**\n * Resolve Dispatch parameters.\n * @param {DispatchParams} params\n * @returns {[string, Payload?, DispatchOptions?]}\n */\nconst resolveParams = params =>\n  isObject(params[0]) ? [params[0].type, params[0], params[1]] : params\n\n/**\n * Generate key from Dispatch parameters.\n * @param {DispatchParams} params\n * @returns {string}\n */\nconst generateKey = params => {\n  const [type, payload] = resolveParams(params)\n  return `${type}:${toString(payload)}`\n}\n\n/**\n * Check if value has timeout property.\n * @param {any} value\n * @returns {value is { timeout: number }}\n */\nconst hasTimeout = value => isObject(value) && typeof value.timeout === 'number'\n\n/**\n * Type alias for options object.\n * @typedef {{ timeout?: number }} Options\n */\n\n/**\n * Resolve timeout from parameters and plugin options.\n * @param {DispatchParams} params\n * @param {Options} [pluginOptions]\n * @returns {number}\n */\nconst resolveTimeout = (params, pluginOptions) => {\n  const dispatchOptions = typeof params[0] === 'string' ? params[2] : params[0]\n  if (hasTimeout(dispatchOptions)) {\n    return dispatchOptions.timeout\n  } else if (hasTimeout(pluginOptions)) {\n    return pluginOptions.timeout\n  }\n  return 0\n}\n\n/**\n * Check if value (time) is expired.\n * @param {number} [expiresIn]\n * @returns {boolean}\n */\nconst isExpired = expiresIn => !!expiresIn && Date.now() > expiresIn\n\n/**\n * Cache's state record.\n * @typedef {{ expiresIn?: number, value: Promise<any> }} CacheRecord\n */\n\n/**\n * Cache's state.\n * @type {Map<string, CacheRecord>}\n */\nconst state = new Map()\n\n/**\n * Define cache property to store, or action context, object.\n * @param {Store} store\n * @param {Options} [options]\n */\nconst defineCache = (store, options) => {\n  const cache = {\n    /**\n     * Dispatch an action and set it on cache.\n     * @param  {...DispatchParams} params\n     * @returns {Promise<any>}\n     */\n    dispatch(...params) {\n      const key = generateKey(params)\n      const { value, expiresIn } = state.get(key) || {}\n\n      if (!!value && !isExpired(expiresIn)) {\n        return value\n      }\n\n      const timeout = resolveTimeout(params, options)\n\n      const record = {\n        expiresIn: timeout ? Date.now() + timeout : undefined,\n        value: store.dispatch.apply(store, params),\n      }\n\n      state.set(key, record)\n\n      return record.value.catch(error => {\n        state.delete(key)\n        return Promise.reject(error)\n      })\n    },\n\n    /**\n     * Check if an action dispatch is on cache.\n     * @param  {...DispatchParams} params\n     * @returns {boolean}\n     */\n    has(...params) {\n      const record = state.get(generateKey(params))\n      return isObject(record) && !isExpired(record.expiresIn)\n    },\n\n    /**\n     * Clear cache. Returns `true` if cache was cleared and `false` otherwise.\n     * @returns {boolean}\n     */\n    clear() {\n      return state.clear()\n    },\n\n    /**\n     * Detele an action dispatch from cache. Returns `true` if it was deleted\n     * and `false` otherwise.\n     * @returns {boolean}\n     */\n    delete(...params) {\n      const key = generateKey(params)\n      return state.delete(key)\n    },\n  }\n\n  Object.defineProperty(store, 'cache', {\n    value: cache,\n    writable: false,\n    enumerable: true,\n    configurable: false,\n  })\n}\n\n/**\n * Type alias for Action.\n * @typedef {import('vuex').Action<any, any>} Action\n */\n\n/**\n * Create cache with options and define it on action context instance.\n * @param {Action} action\n * @param {Options} [options]\n * @returns {Action}\n */\nexport const cacheAction = (action, options) => (context, payload) => {\n  defineCache(context, options)\n  return action(context, payload)\n}\n\n/**\n * Create cache with options and define it on store instance.\n * @param {Options} options\n * @returns {(store: Store) => void}\n */\nconst createCache = options => store => defineCache(store, options)\n\nexport default createCache\n"],"names":["const","isObject","value","generateKey","params","type","resolveParams","payload","JSON","stringify","String","hasTimeout","timeout","isExpired","expiresIn","Date","now","state","Map","defineCache","store","options","cache","dispatch","key","get","pluginOptions","dispatchOptions","resolveTimeout","record","undefined","apply","set","catch","error","delete","Promise","reject","has","clear","Object","defineProperty","writable","enumerable","configurable","action","context"],"mappings":";;;;;sMAKAA,IAAMC,WAAWC,WAAWA,GAA0B,iBAAVA,GA2CtCC,WAAcC,OA/BHF,aAuBKE,UACpBH,EAASG,EAAO,IAAM,CAACA,EAAO,GAAGC,KAAMD,EAAO,GAAIA,EAAO,IAAMA,EAQvCE,CAAcF,wBAC5BC,OAhCVJ,EADeC,EAiCYK,GAhCTC,KAAKC,UAAUP,GAASQ,OAAOR,KAwC7CS,WAAaT,UAASD,EAASC,IAAmC,iBAAlBA,EAAMU,SA4BtDC,WAAYC,WAAeA,GAAaC,KAAKC,MAAQF,GAWrDG,EAAQ,IAAIC,IAOZC,WAAeC,EAAOC,OACpBC,EAAQ,CAMZC,+EACQC,EAAMrB,EAAYC,KACKa,EAAMQ,IAAID,IAAQ,8BAEzCtB,IAAUW,EAAUC,UACjBZ,MAGHU,WAhDYR,EAAQsB,OACxBC,EAAuC,iBAAdvB,EAAO,GAAkBA,EAAO,GAAKA,EAAO,UACvEO,EAAWgB,GACNA,EAAgBf,QACdD,EAAWe,GACbA,EAAcd,QAEhB,EAyCagB,CAAexB,EAAQiB,GAEjCQ,EAAS,CACbf,UAAWF,EAAUG,KAAKC,MAAQJ,OAAUkB,EAC5C5B,MAAOkB,EAAMG,SAASQ,MAAMX,EAAOhB,WAGrCa,EAAMe,IAAIR,EAAKK,GAERA,EAAO3B,MAAM+B,eAAMC,UACxBjB,EAAMkB,OAAOX,GACNY,QAAQC,OAAOH,MAS1BI,0EACQT,EAASZ,EAAMQ,IAAItB,EAAYC,WAC9BH,EAAS4B,KAAYhB,EAAUgB,EAAOf,YAO/CyB,wBACStB,EAAMsB,SAQfJ,6EACQX,EAAMrB,EAAYC,UACjBa,EAAMkB,OAAOX,KAIxBgB,OAAOC,eAAerB,EAAO,QAAS,CACpClB,MAAOoB,EACPoB,UAAU,EACVC,YAAY,EACZC,cAAc,4BAeUC,EAAQxB,mBAAayB,EAASvC,UACxDY,EAAY2B,EAASzB,GACdwB,EAAOC,EAASvC,wBAQLc,mBAAWD,UAASD,EAAYC,EAAOC"}